# ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì„¤ì •
FROM node:20-alpine AS base

# ======================
# 1ë‹¨ê³„: ë¹Œë” ì´ë¯¸ì§€
# ======================
FROM base AS builder
WORKDIR /app

# í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apk update && apk add --no-cache libc6-compat

# í„°ë³´ ì„¤ì¹˜ (Pruneì— ì‚¬ìš©)
RUN npm install -g turbo

# ì „ì²´ í”„ë¡œì íŠ¸ ë³µì‚¬
COPY . .

# apië§Œ ë‚¨ê¸°ê³  prune (ì´ë¯¸ ì‹¤í–‰í–ˆë‹¤ë©´ ìƒëµ ê°€ëŠ¥)
RUN turbo prune api --docker

# ======================
# 2ë‹¨ê³„: ì˜ì¡´ì„± ì„¤ì¹˜
# ======================
FROM base AS installer
WORKDIR /app

# í•„ìˆ˜ íŒŒì¼ ë³µì‚¬ (ë£¨íŠ¸ package.json, lockfile í¬í•¨)
COPY --from=builder /app/out/json/package.json ./package.json
COPY --from=builder /app/out/json/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder /app/out/json/pnpm-workspace.yaml ./pnpm-workspace.yaml

# ğŸ‘‡ shared íŒ¨í‚¤ì§€ë„ ê°™ì´ ë³µì‚¬
COPY --from=builder /app/out/full/packages/shared ./packages/shared

# ì˜ì¡´ì„± ì„¤ì¹˜ (pnpm ê¸°ì¤€)
RUN npm install -g pnpm && pnpm install --frozen-lockfile

# ì „ì²´ ì†ŒìŠ¤ ë³µì‚¬
COPY --from=builder /app/out/full/ .

# ë¹Œë“œ (apië§Œ)
RUN npx turbo run build --filter=api

# ======================
# 3ë‹¨ê³„: ëŸ°íƒ€ì„ ì´ë¯¸ì§€
# ======================
FROM base AS runner
WORKDIR /app

# ë³´ì•ˆ ì‚¬ìš©ì ìƒì„±
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nestjs
USER nestjs

# ë¹Œë“œ ê²°ê³¼ ë³µì‚¬
COPY --from=installer --chown=nestjs:nodejs /app/apps/api/dist ./dist
COPY --from=installer --chown=nestjs:nodejs /app/node_modules ./node_modules
COPY --from=installer --chown=nestjs:nodejs /app/apps/api/package.json ./package.json

EXPOSE 4000
CMD ["node", "dist/main"]